<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * Ext.ux.Calendar
 */
Ext.ns(&quot;Ext.ux&quot;);Ext.ux.Calendar=Ext.extend(Ext.Panel,{cls:&quot;ux-calendar&quot;,autoHeight:true,value:new Date(),weekStart:1,minDate:null,maxDate:null,fullHeight:true,moveToMonthOnDateTap:false,todayCls:&quot;today&quot;,selectedCls:&quot;selected&quot;,unselectableCls:&quot;unselectable&quot;,prevMonthCls:&quot;prev-month&quot;,nextMonthCls:&quot;next-month&quot;,weekendCls:&quot;weekend&quot;,prevPeriodCls:&quot;goto-prev&quot;,nextPeriodCls:&quot;goto-next&quot;,commonTemplateFunctions:{getClasses:function(a){var b=[];if(a.selected){b.push(this.me.selectedCls)}if(a.unselectable){b.push(this.me.unselectableCls)}if(a.prevMonth){b.push(this.me.prevMonthCls)}if(a.nextMonth){b.push(this.me.nextMonthCls)}if(a.weekend){b.push(this.me.weekendCls)}if(a.today){b.push(this.me.todayCls)}return b.join(&quot; &quot;)},isEndOfRow:function(a){return(a%7)===0&amp;&amp;(a&gt;0)},isEndOfPeriod:function(a){return a===this.me.totalDays[this.me.mode](this.me.value)},getDaysArray:function(a){var c=[],b;for(b=0;b&lt;7;b++){c.push(a.dates[b])}return c},getHeaderClass:function(a){return a===1?this.me.prevPeriodCls:a===7?this.me.nextPeriodCls:&quot;&quot;}},constructor:function(a){this.tpl=new Ext.XTemplate('&lt;table class=&quot;{[this.me.mode]}&quot;&gt;',&quot;&lt;thead&gt;&quot;,&quot;&lt;tr&gt;&quot;,'&lt;tpl for=&quot;this.getDaysArray(values)&quot;&gt;','&lt;th class=&quot;{[this.getHeaderClass(xindex)]}&quot;&gt;','&lt;tpl if=&quot;xindex === 4&quot;&gt;','&lt;span&gt;{[parent.currentDate.format(&quot;F&quot;)]} {[parent.currentDate.format(&quot;Y&quot;)]}&lt;/span&gt;',&quot;&lt;/tpl&gt;&quot;,'{date:date(&quot;D&quot;)}',&quot;&lt;/th&gt;&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/tr&gt;&quot;,&quot;&lt;/thead&gt;&quot;,&quot;&lt;tbody&gt;&quot;,&quot;&lt;tr&gt;&quot;,'&lt;tpl for=&quot;dates&quot;&gt;','&lt;td class=&quot;day {[this.getClasses(values)]}&quot; datetime=&quot;{[this.me.getDateAttribute(values.date)]}&quot;&gt;','{date:date(&quot;j&quot;)}',&quot;&lt;/td&gt;&quot;,'&lt;tpl if=&quot;this.isEndOfRow(xindex)&quot;&gt;',&quot;&lt;/tr&gt;&quot;,'&lt;tpl if=&quot;!this.isEndOfPeriod(xindex)&quot;&gt;',&quot;&lt;tr&gt;&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/tr&gt;&quot;,&quot;&lt;/tbody&gt;&quot;,&quot;&lt;/table&gt;&quot;,Ext.apply(this.commonTemplateFunctions,{me:this}));Ext.apply(this,a||{});this.addEvents(&quot;refresh&quot;,&quot;initialrender&quot;,&quot;selectionchange&quot;,&quot;periodchange&quot;);Ext.ux.Calendar.superclass.constructor.call(this,a);this.minDate=this.minDate?this.minDate.clearTime(true):null;this.maxDate=this.maxDate?this.maxDate.clearTime(true):null},initComponent:function(){Ext.apply(this,{totalDays:{month:function(a){var b=a.getFirstDateOfMonth();return this.isWeekend(b)?42:35},week:function(a){return 7}},modeStartFns:{month:this.getMonthStartDate,week:this.getWeekStartDate},modeDeltaFns:{month:this.getMonthDeltaDate,week:this.getWeekDeltaDate}});Ext.ux.Calendar.superclass.initComponent.call(this);this.previousValue=this.value;this.on(&quot;afterrender&quot;,Ext.createDelegate(this.refresh,this,[true],false),this)},onRender:function(b,a){Ext.ux.Calendar.superclass.onRender.apply(this,arguments);this.body.on({click:this.onDayTap,scope:this,delegate:&quot;td&quot;});this.body.on({click:this.onTableHeaderTap,scope:this,delegate:&quot;th&quot;})},setMode:function(a){this.mode=a;this.refresh()},syncHeight:function(){if(this.fullHeight){this.body.down(&quot;table&quot;).setHeight(this.body.getHeight())}},refresh:function(a){this.currentDate=this.currentDate||this.value||new Date();this.dateCollection=this.getDateCollection(this.currentDate.getDate(),this.currentDate.getMonth(),this.currentDate.getFullYear());this.update({currentDate:this.currentDate,dates:this.dateCollection.items});this.body.getHeight();this.syncHeight();this.dateCellEls=this.body.select(&quot;td.day&quot;);if(a){this.fireEvent(&quot;initialrender&quot;,this)}else{this.fireEvent(&quot;refresh&quot;,this)}},onDayTap:function(b,a){a=Ext.fly(a);if(!a.hasCls(this.unselectableCls)){this.setValue(this.getCellDate(a))}},onTableHeaderTap:function(b,a){a=Ext.fly(a);if(a.hasCls(this.prevPeriodCls)||a.hasCls(this.nextPeriodCls)){this.refreshDelta(a.hasCls(this.prevPeriodCls)?-1:1)}},setValue:function(a){if(!this.isSameDay(this.value,a)){this.previousValue=this.value;if(Ext.isDate(a)){this.value=a}else{this.value=null}if(this.value){this.currentDate=this.value;this.selectDate(this.value)}}},selectDate:function(a){var b=false;this.removeSelectedCell();this.body.select(&quot;td&quot;).each(function(d){var c=this.getCellDate(d);if(((!d.hasCls(this.prevMonthCls)&amp;&amp;!d.hasCls(this.nextMonthCls))||!this.moveToMonthOnDateTap)&amp;&amp;this.isSameDay(a,c)){d.addCls(this.selectedCls);if((this.value&amp;&amp;this.previousValue)&amp;&amp;!this.isSameDay(this.value,this.previousValue)){this.fireEvent(&quot;selectionchange&quot;,this,this.previousValue,this.value)}b=true}},this);if(!b){this.refresh()}},refreshDelta:function(d){var b=this.currentDate||new Date();var a=this.modeDeltaFns[this.mode](b,d);if(this.isOutsideMinMax(a)){return}this.currentDate=a;this.refresh();var c=this.getPeriodMinMaxDate();this.fireEvent(&quot;periodchange&quot;,this,c.min.date,c.max.date,(d&gt;0?&quot;forward&quot;:&quot;back&quot;))},getPeriodMinMaxDate:function(){return{min:this.dateCollection.first(),max:this.dateCollection.last()}},isOutsideMinMax:function(a){var b=false;if(this.mode===&quot;month&quot;){b=((this.minDate&amp;&amp;a.getLastDateOfMonth()&lt;this.minDate)||(this.maxDate&amp;&amp;a.getFirstDateOfMonth()&gt;this.maxDate))}else{b=((this.minDate&amp;&amp;this.getWeekEndDate(a.getDate(),a.getMonth(),a.getFullYear())&lt;this.minDate)||(this.maxDate&amp;&amp;this.getWeekStartDate(a.getDate(),a.getMonth(),a.getFullYear())&gt;this.maxDate))}return b},removeSelectedCell:function(){this.body.select(&quot;.&quot;+this.selectedCls).removeCls(this.selectedCls)},getDateCollection:function(j,e,f){var c=new Ext.util.MixedCollection(),d=true,a=new Date(f,e,j),h=Ext.createDelegate(this.modeStartFns[this.mode],this)(j,e,f),g=Ext.createDelegate(this.totalDays[this.mode],this)(a);for(var b=0;b&lt;g;b++){h=new Date(h.getFullYear(),h.getMonth(),h.getDate()+(b===0?0:1));d=(this.minDate&amp;&amp;h&lt;this.minDate)||(this.maxDate&amp;&amp;h&gt;this.maxDate);c.add({today:this.isSameDay(h,new Date()),unselectable:d,selected:this.isSameDay(h,this.value)&amp;&amp;!d,prevMonth:(h.getMonth()&lt;a.getMonth()),nextMonth:(h.getMonth()&gt;a.getMonth()),weekend:this.isWeekend(h),date:h})}return c},getMonthStartDate:function(a,c,b){return this.getWeekStartDate(1,c,b)},getWeekStartDate:function(c,e,d){var a=new Date(d,e,c);var b=a.getDay()-this.weekStart;b=b&lt;0?6:b;return new Date(a.getFullYear(),a.getMonth(),a.getDate()-0-b)},getWeekEndDate:function(c,e,d){var a=new Date(d,e,c);var b=a.getDay()-this.weekStart;b=b&lt;0?6:b;return new Date(a.getFullYear(),a.getMonth(),a.getDate()+0+b)},getMonthDeltaDate:function(b,d){var c=b.getMonth()+d,a=new Date(b.getFullYear(),c,1);a.setDate(a.getDaysInMonth()&lt;b.getDate()?a.getDaysInMonth():b.getDate());return a},getWeekDeltaDate:function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate()+(b*7))},isSameDay:function(b,a){return b.clearTime(true).getTime()===a.clearTime(true).getTime()},isWeekend:function(a){return a.getDay()===0||a.getDay()===6},getCellDate:function(b){var a=b.dom.getAttribute(&quot;datetime&quot;);return this.stringToDate(a)},getDateCell:function(a){return this.body.select('td[datetime=&quot;'+this.getDateAttribute(a)+'&quot;]').first()},getDateAttribute:function(a){return a.format(&quot;Y-m-d&quot;)},stringToDate:function(a){return Date.parseDate(a,&quot;Y-m-d&quot;)}});Ext.ux.CalendarEvents=Ext.extend(Ext.util.Observable,{startEventField:&quot;start&quot;,endEventField:&quot;end&quot;,colourField:&quot;colour&quot;,eventBarCls:&quot;event-bar&quot;,eventWrapperCls:&quot;event-wrapper&quot;,eventBarSelectedCls:&quot;event-bar-selected&quot;,cellHoverCls:&quot;date-cell-hover&quot;,autoUpdateEvent:true,allowEventDragAndDrop:false,eventBarSpacing:1,eventBarTpl:new Ext.XTemplate(&quot;{title}&quot;),init:function(a){this.calendar=a;this.calendar.eventsPlugin=this;this.calendar.addEvents(&quot;eventtap&quot;,&quot;eventdragstart&quot;,&quot;beforeeventdrop&quot;,&quot;eventdrop&quot;,&quot;eventdrag&quot;);this.calendar.on({initialrender:this.refreshEvents,refresh:this.refreshEvents,scope:this})},refreshEvents:function(){this.removeEvents();this.generateEventBars();this.createEventWrapper();this.renderEventBars(this.eventBarStore);if(this.allowEventDragAndDrop){this.createDroppableRegion()}},createDroppableRegion:function(){var b=this;var a=0;this.droppable=new Ext.util.Droppable(this.calendar.body,{onDrag:function(c,h){if(c.el.hasCls(b.eventBarCls)){this.setCanDrop(this.isDragOver(c),c,h);a++;if(a%15===0){var g,f,d=b.getEventRecord(c.el.getAttribute(&quot;eventID&quot;));b.calendar.dateCellEls.removeCls(b.cellHoverCls);b.calendar.dateCellEls.each(function(e,i){var j=e.getPageBox(true);var k=c.el.getPageBox(true);if(j.partial(k)){g=e;f=this.calendar.getCellDate(e);e.addCls(b.cellHoverCls);return}},b);b.calendar.fireEvent(&quot;eventdrag&quot;,c,d,f,g,h);a=0}}}});this.droppable.on({drop:this.onEventDrop,dropdeactivate:this.onEventDropDeactivate,scope:this})},onEventDropDeactivate:function(f,a,d,c){if(a.el.hasCls(this.eventBarCls)){var b=this.getEventRecord(a.el.getAttribute(&quot;eventID&quot;));this.calendar.body.select(&quot;div.&quot;+b.internalId).each(function(e){e.show()},this)}},onEventDrop:function(f,a,d,c){var b=false;this.calendar.dateCellEls.each(function(e){var j=e.getPageBox(true);var k=a.el.getPageBox(true);if(j.partial(k)&amp;&amp;this.calendar.fireEvent(&quot;beforeeventdrop&quot;,a,f,g,d)){b=true;var g=this.getEventRecord(a.el.getAttribute(&quot;eventID&quot;)),h=this.calendar.getCellDate(e),i=this.getDaysDifference(g.get(this.startEventField),h);if(this.autoUpdateEvent){g.set(this.startEventField,h);g.set(this.endEventField,g.get(this.endEventField).add(Date.DAY,i))}this.refreshEvents();this.calendar.fireEvent(&quot;eventdrop&quot;,a,f,g,d);return}},this);this.calendar.dateCellEls.removeCls(this.cellHoverCls);if(!b){a.setOffset(a.startOffset,true)}},generateEventBars:function(){this.eventBarStore=new Ext.data.Store({model:&quot;Ext.ux.CalendarEventBarModel&quot;,data:[]});var c=this.calendar.dateCollection;var a=this.calendar.store;var b;c.each(function(e){var d=e.date,f=d.clearTime(true).getTime(),g=[];a.filterBy(function(i){var h=i.get(this.startEventField).clearTime(true).getTime(),j=i.get(this.endEventField).clearTime(true).getTime();return(h&lt;=f)&amp;&amp;(j&gt;=f)},this);a.sort(this.startEventField,&quot;ASC&quot;);a.each(function(i){var k=this.eventBarStore.findBy(function(l,m){return l.get(&quot;EventID&quot;)===i.internalId},this);if(k&gt;-1){b=this.eventBarStore.getAt(k);while(b.linked().getCount()&gt;0){b=b.linked().getAt(b.linked().getCount()-1)}if(d.getDay()===this.calendar.weekStart){g.push(b.get(&quot;BarPosition&quot;));var h=Ext.ModelMgr.create({EventID:i.internalId,Date:d,BarLength:1,BarPosition:b.get(&quot;BarPosition&quot;),Colour:b.get(&quot;Colour&quot;),Record:i},&quot;Ext.ux.CalendarEventBarModel&quot;);b.linked().add(h)}else{g.push(b.get(&quot;BarPosition&quot;));b.set(&quot;BarLength&quot;,b.get(&quot;BarLength&quot;)+1)}}else{var j=this.getNextFreePosition(g);g.push(j);b=Ext.ModelMgr.create({EventID:i.internalId,Date:d,BarLength:1,BarPosition:j,Colour:this.getRandomColour(),Record:i},&quot;Ext.ux.CalendarEventBarModel&quot;);this.eventBarStore.add(b)}},this);a.clearFilter()},this)},renderEventBars:function(a){var b=this;a.each(function(h){var n=this.getEventRecord(h.get(&quot;EventID&quot;)),k=this.calendar.getDateCell(h.get(&quot;Date&quot;)),o=this.eventBarDoesWrap(h),g=this.eventBarHasWrapped(h);var p=Ext.DomHelper.append(this.eventWrapperEl,{tag:&quot;div&quot;,style:{&quot;background-color&quot;:n.get(this.colourField)},html:this.eventBarTpl.apply(n.data),eventID:h.get(&quot;EventID&quot;),cls:this.eventBarCls+&quot; &quot;+h.get(&quot;EventID&quot;)+(o?&quot; wrap-end&quot;:&quot;&quot;)+(g?&quot; wrap-start&quot;:&quot;&quot;)},true);if(this.allowEventDragAndDrop){new Ext.util.Draggable(p,{revert:true,onStart:function(u){var q=this,t=q.el.getAttribute(&quot;eventID&quot;),r=b.getEventRecord(t),s=b.getEventBarRecord(t);q.el.setWidth(q.el.getWidth()/s.get(&quot;BarLength&quot;));q.el.setLeft(u.startX-(q.el.getWidth()/2));b.calendar.body.select(&quot;div.&quot;+r.internalId).each(function(v){if(v.dom!==q.el.dom){v.hide()}},this);Ext.util.Draggable.prototype.onStart.apply(this,arguments);b.calendar.fireEvent(&quot;eventdragstart&quot;,q,r,u);return true}})}var m=h.get(&quot;BarPosition&quot;),d=h.get(&quot;BarLength&quot;),j=k.getX(),i=k.getY(),c=k.getHeight(),f=k.getWidth(),e=p.getHeight(),l=this.eventBarSpacing;p.setLeft(j+(g?0:l));p.setTop((((i-this.calendar.body.getY())+c)-e)-((m*e+(m*l)+l)));p.setWidth((f*d)-(l*(o?(o&amp;&amp;g?0:1):2)));if(h.linked().getCount()&gt;0){this.renderEventBars(h.linked())}},this)},onEventDragStart:function(a,f){var d=a.el.getAttribute(&quot;eventID&quot;),b=this.getEventRecord(d),c=this.getEventBarRecord(d);a.el.setWidth(a.el.getWidth()/c.get(&quot;BarLength&quot;));a.updateBoundary(true);this.calendar.body.select(&quot;div.&quot;+b.internalId).each(function(e){if(e.dom!==a.el.dom){e.hide()}},this);this.calendar.fireEvent(&quot;eventdragstart&quot;,a,b,f)},eventBarDoesWrap:function(a){var b=a.get(&quot;Date&quot;).add(Date.DAY,(a.get(&quot;BarLength&quot;)-1));return b.clearTime(true).getTime()!==a.get(&quot;Record&quot;).get(this.endEventField).clearTime(true).getTime()},eventBarHasWrapped:function(a){return a.get(&quot;Date&quot;).clearTime(true).getTime()!==a.get(&quot;Record&quot;).get(this.startEventField).clearTime(true).getTime()},createEventWrapper:function(){if(this.calendar.rendered&amp;&amp;!this.eventWrapperEl){this.eventWrapperEl=Ext.DomHelper.append(this.calendar.body,{tag:&quot;div&quot;,cls:this.eventWrapperCls},true);this.calendar.mon(this.eventWrapperEl,&quot;click&quot;,this.onEventWrapperTap,this,{delegate:&quot;div.&quot;+this.eventBarCls})}},onEventWrapperTap:function(d,c){var b=c.attributes.eventID;if(b){var a=this.getEventRecord(c.attributes.eventID.value);this.deselectEvents();this.eventWrapperEl.select(&quot;div.&quot;+a.internalId).addCls(this.eventBarSelectedCls);this.calendar.fireEvent(&quot;eventtap&quot;,a,d)}},getNextFreePosition:function(a){var b=0;while(a.indexOf(b)&gt;-1){b++}return b},getEventRecord:function(a){var b=this.calendar.store.findBy(function(c){return c.internalId===a},this);return this.calendar.store.getAt(b)},getEventBarRecord:function(a){var b=this.eventBarStore.findBy(function(c){return c.get(&quot;EventID&quot;)===a},this);return this.eventBarStore.getAt(b)},deselectEvents:function(){this.calendar.body.select(&quot;.&quot;+this.eventBarSelectedCls).removeCls(this.eventBarSelectedCls)},getDaysDifference:function(b,a){b=b.clearTime(true).getTime();a=a.clearTime(true).getTime();return(a-b)/1000/60/60/24},removeEvents:function(){if(this.eventWrapperEl){this.eventWrapperEl.dom.innerHTML=&quot;&quot;;this.eventWrapperEl.remove();this.eventWrapperEl=null}if(this.eventBarStore){this.eventBarStore.remove(this.eventBarStore.getRange());this.eventBarStore=null}if(this.droppable){this.droppable=null}},getRandomColour:function(){return&quot;#&quot;+(Math.random()*16777215&lt;&lt;0).toString(16)}});Ext.regModel(&quot;Ext.ux.CalendarEventBarModel&quot;,{fields:[{name:&quot;EventID&quot;,type:&quot;string&quot;},{name:&quot;Date&quot;,type:&quot;date&quot;},{name:&quot;BarLength&quot;,type:&quot;int&quot;},{name:&quot;BarPosition&quot;,type:&quot;int&quot;},{name:&quot;Colour&quot;,type:&quot;string&quot;},&quot;Record&quot;],hasMany:[{model:&quot;Ext.ux.CalendarEventBarModel&quot;,name:&quot;linked&quot;}]});Ext.override(Ext.util.Region,{partial:function(g){var f=this,e=g.right-g.left,c=g.bottom-g.top,b=f.right-f.left,a=f.bottom-f.top,d=g.top&gt;f.top&amp;&amp;g.top&lt;f.bottom;horizontalValid=g.left&gt;f.left&amp;&amp;g.left&lt;f.right;return horizontalValid&amp;&amp;d}});Ext.ux.CalendarSimpleEvents=Ext.extend(Ext.util.Observable,{dateField:&quot;start&quot;,multiEventDots:false,wrapperCls:&quot;simple-event-wrapper&quot;,eventDotCls:&quot;simple-event&quot;,eventTpl:new Ext.XTemplate('&lt;span class=&quot;{wrapperCls}&quot;&gt;','&lt;tpl for=&quot;events&quot;&gt;','&lt;span class=&quot;{[parent.eventDotCls]}&quot;&gt;&lt;/span&gt;',&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/span&gt;&quot;),filterFn:function(b,c,a){return b.get(this.dateField).clearTime(true).getTime()===a.clearTime(true).getTime()},init:function(a){this.calendar=a;this.calendar.simpleEventsPlugin=this;this.wrapperCls=this.wrapperCls+(this.multiEventDots?&quot;-multi&quot;:&quot;&quot;);this.eventDotCls=this.eventDotCls+(this.multiEventDots?&quot;-multi&quot;:&quot;&quot;);this.calendar.showEvents=this.showEvents;this.calendar.hideEvents=this.hideEvents;this.calendar.removeEvents=this.removeEvents;this.calendar.on({refresh:this.renderEvents,initialrender:this.renderEvents,scope:this})},renderEvents:function(){if(!this.disabled){var a=this.calendar.dateCollection;if(a){a.each(function(d){var f=d.date;var c=this.calendar.getDateCell(f);var e=this.calendar.store;if(c){e.clearFilter();var b=e[this.multiEventDots?&quot;filterBy&quot;:&quot;findBy&quot;](Ext.createDelegate(this.filterFn,this,[f],true));if((!this.multiEventDots&amp;&amp;b&gt;-1)||(this.multiEventDots&amp;&amp;e.getRange().length&gt;0)){var g=this.eventTpl.append(c,{events:(this.multiEventDots?e.getRange():[&quot;event&quot;]),wrapperCls:this.wrapperCls,eventDotCls:this.eventDotCls},true)}}},this)}}},hideEvents:function(){this.simpleEventsPlugin.disabled=true;this.body.select(&quot;span.&quot;+this.wrapperCls).hide()},showEvents:function(){this.simpleEventsPlugin.disabled=false;this.body.select(&quot;span.&quot;+this.wrapperCls).show()},removeEvents:function(){this.body.select(&quot;span.&quot;+this.wrapperCls).remove()}});</pre>
</body>
</html>
